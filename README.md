Description
===========

This repository contains stage one bootstrapping for instances in Syseleven's
Openstack cloud, plus stage zero bootstrapping for other environments.

Its purpose is to deploy a minimum of configuration repositories, generate
Hiera configuration (if applicable) and bootstrap an instance to the point
where it can either run Puppet standalone (i.e. from its own Hiera
configuration) or retrieve its configuration from a Puppet master.

Organization
============

This repository contains a range of standardized files and directories. Please
adhere to this organization when forking it to maintain compatibility with the
remaining components of our bootstrapping system. All non-absolute paths in
this document are relative to the repository's root directory.

bin/
----

This directory contains scripts and other executables used in the course of the
bootstrapping process. *initialize_instance* includes it in its PATH variable
for easy use.

initialize_instance
-------------------

This is the default first stage bootstrap script invoked by the Syseleven
Openstack cloud's standard user-data script (Heat resource
`sys11::cloudstrap::v4` and later). It logs its output to
/var/log/initialize_instance.log.

stage0/
-------

This directory contains various bootstrapping scripts for running Cloudstrap in
non-Openstack environments. These scripts may be used for Cloudstrap
deployments on bare metal machines, local development VMs or other environments
without EC2 style metadata/user data passing mechanisms.

Environment
===========

`initialize_instance` uses the following environment variables:

* In the Syseleven Openstack cloud these variables are set through Heat, as
  properties of the `sys11::cloudstrap::v4` resource. They are templated into
  the user data script generated by the resource.

* The `stage0/bootstrap.simple` script contains defaults for all of these
  environment variables and will override them from its environment if they are
  set.

metadata parameters
===================

Bootstrapping behaviour is governed by the metadata parameters listed below.
They are passed to an instance in various way, depending on the stage 0
bootstrapping script being used:

* In Syseleven's Openstack cloud they are supplied as EC2 metadata entries and
  passed into an instance by cloud-init.

* By using the -m option to the `stage0/bootstrap.simple` script (may be given multiple
  times and takes a `=` delimited key-value pair as its sole argument, e.g. `-P
  project_classes=true`).

project_classes
---------------

*type: boolean*

This parameter controls the addition of the following hierarchy entries in
hiera.yaml:

```
  - "project-config/nodes.d/%{::fqdn}"
  - "project-config/nodetypes.d/%{::nodetype}"
```

If project_classes is set to true, these entries are added to hiera.yaml, if it
is set to false they are omitted. This option should be set to true on a puppet
master or a node deployed through masterless puppet, and false on all puppet
agents. This prevents the classes array provided by the puppet master from
being used in puppet agents' early bootstrapping phase. If this parameter is
not present it is assumed to be false.

puppet_master
-------------

type: string (FQDN)

This parameter contains the fully qualified domain name of the puppet master,
puppet agents are retrieve their configuration from. This should be set on both
puppet agents and the puppet master, since the puppet master itself is usually
managed from the same source.

sys11_topics
------------

*Type: string (space delimited list)*

This parameter is  a space delimited list of configuration topics from
sys11-config to deploy. This is commonly used for early stage bootstrapping,
i.e. for getting a node to a point where it can act as a puppet agent or puppet
master.

