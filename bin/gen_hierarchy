#!/usr/bin/env bash
# 2015, j.grassler@syseleven.de

# gen_hierarchy - Generate Hiera hierarchy array for a cloudstrap configuration checkout

config_dir=/opt/config/sys11
config_name=sys11

usage()
  {
  echo 'usage:'
  echo "  $0 [--dir <source dir>] --include <include> [--include <include> ...] <topic> [<topic> ...]"
  echo
  echo '  options:'
  echo '    --dir <source dir>  Generate hierarchy for configuration in <dir> (defaults to /opt/sys11-config)'
  echo '    --prefix <name>     Prefix hierarchy entries with <name>. Can include facts. (defaults to "sys11-config")'
  echo "    --include <subdir>  Include subdirectory <subdir> of <source dir> in hierarchy. May occur several times."
  }

while [[ $1 ]]; do
  case $1 in
    --dir)
      config_dir=$2
      shift 2
      ;;
    --prefix)
      config_name=$2
      shift 2
      ;;
    --include)
      includes+=("$2")
      shift 2
      ;;
    -h)
      usage
      exit 0
      ;;
    *)
      args+=("$1")
      shift 1
      ;;
   esac
done

if [ -z "$args" ]; then
  usage
  exit 1
fi

# Generates hierarchy entries for all yaml files in a directory tree
gen_entries()
  {
  dir=$1
  topicdir=$2
  config_name=$3

  find "${dir}/${topicdir}" -type f \
    | grep '\.yaml$' \
    | sed -e 's/\.yaml$//' \
    | sed "s#.*\(${topicdir}.*\)#$config_name/\1#" \
    | sed 's/^/  - "/' \
    | sed 's/$/"/'
  }

for include in ${includes[*]}
do
  for topic in ${args[*]}
  do
    gen_entries "${config_dir}/puppet/hieradata/" "$include" "$config_name" | grep $topic
  done
done
