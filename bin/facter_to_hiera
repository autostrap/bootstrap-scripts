#!/usr/bin/env python
# 2015, s.andres@syseleven.de

import json
import re
from subprocess import check_output
from optparse import OptionParser

def process_args():

    parser = OptionParser()
    parser.add_option("--key", action="append", help='You may pass key=value '
                        'multiple times to this parameters.'
                        'If key is contained in the facter output, it will change its value to the value passed.')

    (options, args) = parser.parse_args()

    #if not options.key and not options.showall:
    #    parser.error("option -k is mandatory")


    return options, args

if __name__ == '__main__':
    options, args = process_args()

    facts = json.loads(check_output('facter -j', shell=True))
    facts_new = {}
    for fact in facts:
        if options.key:
            for option in options.key:
                o = option.split('=')
                if o[0] == fact:
                    #print "change from %s to %s" % (fact, o[1])
                    facts[fact] = o[1]

        fact_replaced = re.sub('(.*)', '::\g<1>', fact)
        facts_new[fact_replaced] = facts[fact]

    print json.dumps(facts_new)
