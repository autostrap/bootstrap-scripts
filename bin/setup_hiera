#!/usr/bin/env bash

sys11_topics="$(jq -r .meta.sys11_topics /config/openstack/latest/meta_data.json)"
sys11_hiera_opts="$(jq -r .meta.sys11_hiera_opts /config/openstack/latest/meta_data.json)"

if [ "$sys11_topics" = "null" ]; then
  sys11_topics="base firewall"
fi

if [ "$sys11_hiera_opts" = "null" ]; then
  sys11_hiera_opts=""
fi

mkdir /etc/puppet/hieradata

cat > /etc/puppet/hiera.yaml <<EOF
---
:backends:
  - yaml
:logger: puppet
:yaml:
  :datadir: /etc/puppet/hieradata
  :puppet:
    :datasource: data

:hierarchy:
EOF

gen_hierarchy -d ${config_dir} ${sys11_hiera_opts} -n sys11-defaults ${sys11_topics} >> /etc/puppet/hiera.yaml

ln -s ${config_dir}/puppet/hieradata /etc/puppet/hieradata/sys11-defaults
ln -sf /etc/puppet/hiera.yaml /etc/hiera.yaml

cp /opt/override.yaml /etc/puppet/hieradata/override.yaml

ln -s ${scripts_dir}/bin/run_puppet_hiera /usr/local/bin
ln -s ${scripts_dir}/bin/really_run_puppet_agent /usr/local/bin
ln -s ${scripts_dir}/bin/run_repodeploy /usr/local/bin

cp /opt/openstack-puppet/sys11puppet/files/puppetmaster_site.pp /etc/puppet/manifests/site.pp

run_repodeploy  # Deploy configured repositories (if any)
